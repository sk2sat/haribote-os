# 4-1 C言語からメモリに書き込みたい

はい，C言語がいい感じに使えるようになったので色々やっていこうと思います．
思うのですが，画面が真っ黒のままでは面白くないです．
というわけで画面に何か描きます．
画面に何か描くにはVRAMに何か書きこめばいいので，MOVすればいいわけです．

で，C言語で指定したメモリに何か書く方法なんですが，これがあの悪名高きポインタってやつなんですね．
なのでポインタは一旦置いておいて，ポインタ以外の方法を使います．
ではどうするのかというと，ようはMOVをすればいいので，MOVする関数をアセンブラで作ってそれを呼び出してやります．

これをやるのがnaskfunc.nasのwrite_mem8関数です．
ちなみに，今までスルーしてましたがC用の関数をアセンブラで作る場合には関数名の最初にアンダースコアをつけます．
Cで作った関数をコンパイルしてアセンブラになったところを見ると同じようになっています
(なお，C++だと名前マングリングというものがありこうはいきません)．

write_mem8では引数としてアドレスとデータを取っていますが，Cの関数で引数がどのように扱われるのかというと，
n番目の引数は```[ESP+ 4*n]```に格納されています(実はこれは32bitの時の話で，64bitになると最初の数個がレジスタだったりします)．

ようは第1引数をECXに入れて，第2引数をALに入れて，ECXの番地にALを入れているだけです．
単純ですね．

あとはこの関数を使ってVRAMに書き込めばいいわけです．
現在のモードでのVRAMのアドレスは0xa0000〜0xaffffなので，for文でループしてVRAMを15で埋め尽くしています．
この15というのは色の番号で，ここでは白なのでこれを実行すると真っ白になります．

# 4-2 しましま模様
画面が真っ白でも面白くないので，しましま模様を描いてみます．
まあ真っ白な画面を印刷しても印刷された時にただの真っ白になってしまうという筆者の都合もあったようですが()．

で，どうやってしましま模様にするかですが，AND演算を使っています．
ANDというのはそれぞれの(2進数の)桁についてどちらも1のときだけ1にして，それ以外の時は0にするという演算です．

これを使うと，特定のビットだけを取り出すことができます
(```A AND B```なら，AのうちBを1にしたビットだけが抽出される)．

じゃあ今回はどうしているのかというと，描画するデータを書き込むアドレスと0x0fのANDをとったものにしています．
0x0fは2進数にすると00001111なので，書き込むアドレスの下位4bitを取り出していることになります．

ここで，アドレスはfor文でループして1ずつ加算されていくので，下位4bitは0〜15(=0x0f=0b00001111)の範囲でループする，というわけです．
色番号0〜15で順番に描画されていき，結果的にしましま模様になるわけですね．


また，ANDの他にORやXORという演算もあります．
ORはどちらかが1なら1にする(特定のビットを1にする)，XORは特定のビットを反転させる演算です．
